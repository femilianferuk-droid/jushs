#!/usr/bin/env python3
"""
Telegram Web Client –Ω–∞ Pyrogram –∏ Flask
–í—Å–µ –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ: telegram_client.py
"""

import os
import asyncio
import json
import sqlite3
import hashlib
import time
from datetime import datetime, timedelta
from typing import Dict, List, Optional, Tuple, Any
from pathlib import Path

from flask import Flask, render_template_string, request, jsonify, session, redirect, url_for, send_file
from pyrogram import Client, filters, types, enums
from pyrogram.errors import FloodWait, SessionPasswordNeeded, PhoneCodeInvalid, PhoneCodeExpired
from pyrogram.storage import SQLiteStorage

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Flask
app = Flask(__name__)
app.secret_key = os.urandom(24)
app.config['PERMANENT_SESSION_LIFETIME'] = timedelta(days=7)

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BASE_DIR = Path(__file__).parent
SESSION_DB = BASE_DIR / 'sessions.db'
MEDIA_CACHE = BASE_DIR / 'media_cache'
MEDIA_CACHE.mkdir(exist_ok=True)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î –¥–ª—è —Å–µ—Å—Å–∏–π
def init_db():
    conn = sqlite3.connect(SESSION_DB)
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS user_sessions
                 (user_id INTEGER PRIMARY KEY,
                  session_string TEXT,
                  phone_number TEXT,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
    c.execute('''CREATE TABLE IF NOT EXISTS api_credentials
                 (id INTEGER PRIMARY KEY AUTOINCREMENT,
                  api_id INTEGER,
                  api_hash TEXT,
                  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP)''')
    conn.commit()
    conn.close()

init_db()

# –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
clients = {}
user_states = {}

# HTML –®–ê–ë–õ–û–ù–´ ===============================================================

BASE_HTML = '''
<!DOCTYPE html>
<html lang="ru" data-theme="{{ theme|default('light') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #40A7E3;
            --primary-dark: #2D96D1;
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --bg-tertiary: #e4e6eb;
            --text-primary: #050505;
            --text-secondary: #65676b;
            --border-color: #e4e6eb;
            --message-in: #ffffff;
            --message-out: #d9fdd3;
            --unread-badge: #40A7E3;
            --online-indicator: #31A24C;
        }

        [data-theme="dark"] {
            --primary-color: #40A7E3;
            --primary-dark: #2D96D1;
            --bg-primary: #1a1a1a;
            --bg-secondary: #242526;
            --bg-tertiary: #3a3b3c;
            --text-primary: #e4e6eb;
            --text-secondary: #b0b3b8;
            --border-color: #3e4042;
            --message-in: #242526;
            --message-out: #005c4b;
            --unread-badge: #40A7E3;
            --online-indicator: #31A24C;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
            max-width: 1400px;
            margin: 0 auto;
            background-color: var(--bg-primary);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ */
        .sidebar {
            width: 350px;
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .user-name {
            font-weight: 600;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .logout-btn:hover {
            background-color: var(--bg-tertiary);
        }

        .search-container {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-box {
            width: 100%;
            padding: 10px 15px;
            border-radius: 20px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .search-box:focus {
            border-color: var(--primary-color);
        }

        .chats-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .chat-item {
            display: flex;
            padding: 12px 20px;
            gap: 15px;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid var(--border-color);
        }

        .chat-item:hover {
            background-color: var(--bg-secondary);
        }

        .chat-item.active {
            background-color: var(--bg-tertiary);
        }

        .chat-avatar {
            position: relative;
            flex-shrink: 0;
        }

        .avatar-img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .avatar-placeholder {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
        }

        .online-status {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--online-indicator);
            border: 2px solid var(--bg-primary);
        }

        .chat-info {
            flex: 1;
            min-width: 0;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-title {
            font-weight: 600;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-time {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .chat-preview {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-text {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
        }

        .unread-badge {
            background-color: var(--unread-badge);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            font-weight: 600;
            margin-left: 8px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏ —á–∞—Ç–∞ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-primary);
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .chat-user-info {
            flex: 1;
        }

        .chat-user-name {
            font-weight: 600;
            font-size: 18px;
        }

        .chat-user-status {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .chat-actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .action-btn:hover {
            background-color: var(--bg-tertiary);
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background-color: var(--bg-secondary);
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%233a3b3c' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .message-date {
            text-align: center;
            margin: 20px 0;
            position: relative;
        }

        .date-label {
            display: inline-block;
            padding: 5px 15px;
            background-color: var(--bg-tertiary);
            border-radius: 15px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .message-wrapper {
            margin-bottom: 10px;
            display: flex;
        }

        .message-wrapper.outgoing {
            justify-content: flex-end;
        }

        .message {
            max-width: 65%;
            padding: 8px 12px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
        }

        .message.incoming {
            background-color: var(--message-in);
            border-bottom-left-radius: 4px;
        }

        .message.outgoing {
            background-color: var(--message-out);
            border-bottom-right-radius: 4px;
        }

        .message-text {
            font-size: 15px;
            line-height: 1.4;
        }

        .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 2px;
            margin-left: 10px;
            float: right;
        }

        .message-status {
            display: inline-block;
            margin-left: 4px;
        }

        .media-preview {
            margin-top: 8px;
            border-radius: 12px;
            overflow: hidden;
            max-width: 300px;
        }

        .media-preview img {
            width: 100%;
            height: auto;
            display: block;
        }

        .typing-indicator {
            display: flex;
            padding: 10px 20px;
            align-items: center;
            gap: 8px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--text-secondary);
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-5px);
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –≤–≤–æ–¥–∞ */
        .input-container {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-primary);
        }

        .input-area {
            display: flex;
            align-items: flex-end;
            gap: 15px;
        }

        .input-attachments {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .attachment-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }

        .attachment-btn:hover {
            background-color: var(--bg-tertiary);
        }

        .message-input {
            flex: 1;
            padding: 12px 20px;
            border-radius: 25px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            resize: none;
            max-height: 150px;
            min-height: 50px;
            line-height: 1.4;
        }

        .message-input:focus {
            border-color: var(--primary-color);
        }

        .send-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background-color: var(--primary-dark);
        }

        .send-btn:disabled {
            background-color: var(--bg-tertiary);
            cursor: not-allowed;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: var(--bg-secondary);
            padding: 20px;
        }

        .auth-box {
            background-color: var(--bg-primary);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo {
            color: var(--primary-color);
            font-size: 40px;
            margin-bottom: 15px;
        }

        .auth-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 15px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            border-color: var(--primary-color);
        }

        .auth-btn {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .auth-btn:hover {
            background-color: var(--primary-dark);
        }

        .auth-btn:disabled {
            background-color: var(--bg-tertiary);
            cursor: not-allowed;
        }

        .auth-footer {
            text-align: center;
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        .auth-link {
            color: var(--primary-color);
            text-decoration: none;
        }

        .auth-link:hover {
            text-decoration: underline;
        }

        .error-message {
            background-color: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .theme-switcher {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .theme-btn {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .theme-btn:hover {
            background-color: var(--bg-tertiary);
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-in-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 70vh;
            }
            
            .chat-area {
                height: 30vh;
            }
            
            .message {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    {% if not session.get('user_id') %}
    <div class="theme-switcher">
        <button class="theme-btn" onclick="toggleTheme()">
            <i class="fas fa-moon"></i>
            <span>–¢–µ–º–∞</span>
        </button>
    </div>
    {% endif %}
    
    {% block content %}{% endblock %}
    
    <script>
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ–º–æ–π
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }
        
        // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã –∏–∑ localStorage
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.querySelector('.form-input, .message-input');
            if (input) input.focus();
        });
    </script>
</body>
</html>
'''

LOGIN_HTML = '''
{% extends "base.html" %}
{% block content %}
<div class="auth-container fade-in">
    <div class="auth-box">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fab fa-telegram"></i>
            </div>
            <h1 class="auth-title">Telegram Web</h1>
            <p class="auth-subtitle">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç Telegram</p>
        </div>
        
        {% if error %}
        <div class="error-message">
            {{ error }}
        </div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('api_login') }}">
            <div class="form-group">
                <label class="form-label" for="api_id">API ID</label>
                <input type="number" class="form-input" id="api_id" name="api_id" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API ID" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="api_hash">API Hash</label>
                <input type="text" class="form-input" id="api_hash" name="api_hash" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à API Hash" required>
            </div>
            
            <button type="submit" class="auth-btn">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
        </form>
        
        <div class="auth-footer">
            <p>–ü–æ–ª—É—á–∏—Ç—å API ID –∏ Hash –º–æ–∂–Ω–æ –Ω–∞ <a href="https://my.telegram.org" 
               class="auth-link" target="_blank">my.telegram.org</a></p>
        </div>
    </div>
</div>
{% endblock %}
'''

PHONE_HTML = '''
{% extends "base.html" %}
{% block content %}
<div class="auth-container fade-in">
    <div class="auth-box">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fab fa-telegram"></i>
            </div>
            <h1 class="auth-title">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</h1>
            <p class="auth-subtitle">–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞, –ø—Ä–∏–≤—è–∑–∞–Ω–Ω—ã–π –∫ –∞–∫–∫–∞—É–Ω—Ç—É Telegram</p>
        </div>
        
        {% if error %}
        <div class="error-message">
            {{ error }}
        </div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('send_code') }}">
            <div class="form-group">
                <label class="form-label" for="phone">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</label>
                <input type="tel" class="form-input" id="phone" name="phone" 
                       placeholder="+79991234567" pattern="\+[0-9]{11,15}" required>
                <small style="color: var(--text-secondary); margin-top: 5px; display: block;">
                    –§–æ—Ä–º–∞—Ç: +79991234567
                </small>
            </div>
            
            <button type="submit" class="auth-btn">
                –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥
            </button>
        </form>
        
        <div class="auth-footer">
            <a href="{{ url_for('logout') }}" class="auth-link">–ù–∞–∑–∞–¥</a>
        </div>
    </div>
</div>
{% endblock %}
'''

CODE_HTML = '''
{% extends "base.html" %}
{% block content %}
<div class="auth-container fade-in">
    <div class="auth-box">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fab fa-telegram"></i>
            </div>
            <h1 class="auth-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</h1>
            <p class="auth-subtitle">–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ SMS —Å –∫–æ–¥–æ–º –Ω–∞ –Ω–æ–º–µ—Ä {{ phone }}</p>
        </div>
        
        {% if error %}
        <div class="error-message">
            {{ error }}
        </div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('verify_code') }}">
            <div class="form-group">
                <label class="form-label" for="code">5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥</label>
                <input type="text" class="form-input" id="code" name="code" 
                       placeholder="12345" pattern="[0-9]{5}" maxlength="5" required
                       style="text-align: center; font-size: 24px; letter-spacing: 5px;">
            </div>
            
            <button type="submit" class="auth-btn">
                –í–æ–π—Ç–∏
            </button>
        </form>
        
        <div class="auth-footer">
            <a href="{{ url_for('phone') }}" class="auth-link">–ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä</a>
            <span style="margin: 0 10px;">‚Ä¢</span>
            <a href="#" class="auth-link" onclick="resendCode()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ</a>
        </div>
    </div>
</div>

<script>
function resendCode() {
    fetch('{{ url_for("resend_code") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({phone: '{{ phone }}'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ!');
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    });
}
</script>
{% endblock %}
'''

PASSWORD_HTML = '''
{% extends "base.html" %}
{% block content %}
<div class="auth-container fade-in">
    <div class="auth-box">
        <div class="auth-header">
            <div class="auth-logo">
                <i class="fab fa-telegram"></i>
            </div>
            <h1 class="auth-title">–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h1>
            <p class="auth-subtitle">–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –∞–∫–∫–∞—É–Ω—Ç</p>
        </div>
        
        {% if error %}
        <div class="error-message">
            {{ error }}
        </div>
        {% endif %}
        
        <form method="POST" action="{{ url_for('check_password') }}">
            <div class="form-group">
                <label class="form-label" for="password">–ü–∞—Ä–æ–ª—å</label>
                <input type="password" class="form-input" id="password" name="password" 
                       placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å" required>
            </div>
            
            <button type="submit" class="auth-btn">
                –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
            </button>
        </form>
        
        <div class="auth-footer">
            <a href="{{ url_for('logout') }}" class="auth-link">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –Ω–∞—á–∞–ª—É</a>
        </div>
    </div>
</div>
{% endblock %}
'''

MAIN_HTML = '''
{% extends "base.html" %}
{% block content %}
<div class="app-container">
    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="user-info">
                <div class="user-avatar">
                    {{ user.first_name[0] if user.first_name else 'U' }}
                </div>
                <div>
                    <div class="user-name">
                        {{ user.first_name }} {{ user.last_name or '' }}
                    </div>
                    <div style="font-size: 12px; color: var(--text-secondary);">
                        {{ user.username or '–ë–µ–∑ –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è' }}
                    </div>
                </div>
            </div>
            <button class="logout-btn" onclick="logout()" title="–í—ã–π—Ç–∏">
                <i class="fas fa-sign-out-alt"></i>
            </button>
        </div>
        
        <div class="search-container">
            <input type="text" class="search-box" placeholder="–ü–æ–∏—Å–∫..." 
                   oninput="searchChats(this.value)">
        </div>
        
        <div class="chats-list" id="chatsList">
            <div class="loading-chats">
                <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                    <i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤...
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
    <div class="chat-area" id="chatArea">
        <div class="welcome-screen" style="display: flex; align-items: center; justify-content: center; height: 100%;">
            <div style="text-align: center; color: var(--text-secondary);">
                <div style="font-size: 48px; margin-bottom: 20px; color: var(--primary-color);">
                    <i class="fab fa-telegram"></i>
                </div>
                <h2 style="margin-bottom: 10px;">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Telegram Web</h2>
                <p>–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –Ω–∞—á–∞–ª–∞ –æ–±—â–µ–Ω–∏—è</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentChatId = null;
let isLoadingMessages = false;
let allChatsLoaded = false;
let offset = 0;
const limit = 20;

// –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤
async function loadChats() {
    try {
        const response = await fetch(`/api/chats?offset=${offset}&limit=${limit}`);
        const data = await response.json();
        
        if (data.success) {
            const chatsList = document.getElementById('chatsList');
            
            if (offset === 0) {
                chatsList.innerHTML = '';
            }
            
            if (data.chats.length === 0) {
                allChatsLoaded = true;
                if (offset === 0) {
                    chatsList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
                }
                return;
            }
            
            data.chats.forEach(chat => {
                const chatElement = createChatElement(chat);
                chatsList.appendChild(chatElement);
            });
            
            offset += limit;
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ —á–∞—Ç–∞
function createChatElement(chat) {
    const div = document.createElement('div');
    div.className = 'chat-item';
    div.dataset.chatId = chat.id;
    div.onclick = () => selectChat(chat.id, chat.title);
    
    let avatarContent = '';
    if (chat.photo) {
        avatarContent = `<img src="/api/media/${chat.photo}" alt="${chat.title}" class="avatar-img">`;
    } else {
        const initials = chat.title.substring(0, 1).toUpperCase();
        avatarContent = `<div class="avatar-placeholder" style="background-color: ${getColorForString(chat.title)}">
                          ${initials}
                        </div>`;
    }
    
    const time = chat.last_message_date ? formatTime(chat.last_message_date) : '';
    const preview = chat.last_message ? chat.last_message.substring(0, 30) + (chat.last_message.length > 30 ? '...' : '') : '';
    
    div.innerHTML = `
        <div class="chat-avatar">
            ${avatarContent}
            ${chat.is_online ? '<div class="online-status"></div>' : ''}
        </div>
        <div class="chat-info">
            <div class="chat-header">
                <div class="chat-title">${escapeHtml(chat.title)}</div>
                <div class="chat-time">${time}</div>
            </div>
            <div class="chat-preview">
                <div class="preview-text">${escapeHtml(preview)}</div>
                ${chat.unread_count > 0 ? `<span class="unread-badge">${chat.unread_count}</span>` : ''}
            </div>
        </div>
    `;
    
    return div;
}

// –í—ã–±–æ—Ä —á–∞—Ç–∞
async function selectChat(chatId, chatTitle) {
    if (currentChatId === chatId) return;
    
    currentChatId = chatId;
    
    // –û–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –≤ —Å–ø–∏—Å–∫–µ
    document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.chatId == chatId) {
            item.classList.add('active');
        }
    });
    
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è
    await loadMessages(chatId, chatTitle);
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
async function loadMessages(chatId, chatTitle) {
    try {
        const response = await fetch(`/api/messages/${chatId}`);
        const data = await response.json();
        
        if (data.success) {
            const chatArea = document.getElementById('chatArea');
            chatArea.innerHTML = createChatInterface(chatTitle, data.messages);
            
            // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑
            const messagesContainer = chatArea.querySelector('.messages-container');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
            setupMessageSending(chatId);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    }
}

// –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ —á–∞—Ç–∞
function createChatInterface(chatTitle, messages) {
    let messagesHtml = '';
    let lastDate = null;
    
    messages.forEach(msg => {
        const msgDate = new Date(msg.date * 1000).toLocaleDateString();
        
        if (msgDate !== lastDate) {
            messagesHtml += `
                <div class="message-date">
                    <span class="date-label">${msgDate}</span>
                </div>
            `;
            lastDate = msgDate;
        }
        
        const time = new Date(msg.date * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        messagesHtml += `
            <div class="message-wrapper ${msg.outgoing ? 'outgoing' : 'incoming'}">
                <div class="message ${msg.outgoing ? 'outgoing' : 'incoming'}">
                    ${msg.text ? `<div class="message-text">${escapeHtml(msg.text)}</div>` : ''}
                    ${msg.media ? `<div class="media-preview"><img src="/api/media/${msg.media}" alt="–ú–µ–¥–∏–∞"></div>` : ''}
                    <div class="message-time">
                        ${time}
                        ${msg.outgoing ? `<span class="message-status">${getStatusIcon(msg.status)}</span>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    return `
        <div class="chat-header">
            <div class="chat-avatar">
                <div class="avatar-placeholder">
                    ${chatTitle.substring(0, 1).toUpperCase()}
                </div>
            </div>
            <div class="chat-user-info">
                <div class="chat-user-name">${escapeHtml(chatTitle)}</div>
                <div class="chat-user-status">–≤ —Å–µ—Ç–∏</div>
            </div>
            <div class="chat-actions">
                <button class="action-btn" title="–ü–æ–∏—Å–∫">
                    <i class="fas fa-search"></i>
                </button>
                <button class="action-btn" title="–ú–µ–Ω—é">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
            </div>
        </div>
        
        <div class="messages-container" id="messagesContainer">
            ${messagesHtml}
            <div id="typingIndicator" style="display: none;">
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                    –ü–µ—á–∞—Ç–∞–µ—Ç...
                </div>
            </div>
        </div>
        
        <div class="input-container">
            <div class="input-attachments">
                <button class="attachment-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–æ—Ç–æ" onclick="attachMedia('photo')">
                    <i class="fas fa-image"></i>
                </button>
                <button class="attachment-btn" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª" onclick="attachMedia('document')">
                    <i class="fas fa-paperclip"></i>
                </button>
                <button class="attachment-btn" title="–≠–º–æ–¥–∑–∏">
                    <i class="far fa-smile"></i>
                </button>
            </div>
            <div class="input-area">
                <textarea class="message-input" id="messageInput" 
                          placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." 
                          onkeydown="handleKeyDown(event)"
                          rows="1"></textarea>
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
        
        <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
    `;
}

// –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
function setupMessageSending(chatId) {
    window.sendMessage = async function() {
        const input = document.getElementById('messageInput');
        const text = input.value.trim();
        
        if (!text) return;
        
        try {
            const response = await fetch('/api/send_message', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    text: text
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                input.value = '';
                // –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Å–ø–∏—Å–æ–∫
                addMessageToChat(data.message);
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
        }
    };
}

// –î–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
function addMessageToChat(message) {
    const messagesContainer = document.getElementById('messagesContainer');
    const time = new Date(message.date * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    
    const messageHtml = `
        <div class="message-wrapper outgoing">
            <div class="message outgoing">
                <div class="message-text">${escapeHtml(message.text)}</div>
                <div class="message-time">
                    ${time}
                    <span class="message-status">${getStatusIcon('pending')}</span>
                </div>
            </div>
        </div>
    `;
    
    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à
function handleKeyDown(event) {
    const input = event.target;
    
    // –ê–≤—Ç–æ-–≤—ã—Å–æ—Ç–∞ textarea
    input.style.height = 'auto';
    input.style.height = (input.scrollHeight) + 'px';
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Ctrl+Enter –∏–ª–∏ Cmd+Enter
    if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter (–±–µ–∑ Shift)
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
    }
}

// –ü—Ä–∏–∫—Ä–µ–ø–ª–µ–Ω–∏–µ –º–µ–¥–∏–∞
function attachMedia(type) {
    const input = document.getElementById('fileInput');
    input.accept = type === 'photo' ? 'image/*' : '*/*';
    input.click();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    // –ó–¥–µ—Å—å –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞
    alert(`–§–∞–π–ª "${file.name}" –≤—ã–±—Ä–∞–Ω. –ó–∞–≥—Ä—É–∑–∫–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ.`);
}

// –ü–æ–∏—Å–∫ —á–∞—Ç–æ–≤
function searchChats(query) {
    // –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞
    console.log('–ü–æ–∏—Å–∫:', query);
}

// –í—ã—Ö–æ–¥
function logout() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
        window.location.href = '/logout';
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getColorForString(str) {
    const colors = ['#40A7E3', '#FF6B6B', '#4ECDC4', '#FFD166', '#06D6A0', '#118AB2', '#EF476F'];
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
    }
    return colors[Math.abs(hash) % colors.length];
}

function formatTime(timestamp) {
    const date = new Date(timestamp * 1000);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 86400000) { // –ú–µ–Ω–µ–µ —Å—É—Ç–æ–∫
        return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    } else if (diff < 604800000) { // –ú–µ–Ω–µ–µ –Ω–µ–¥–µ–ª–∏
        return date.toLocaleDateString([], {weekday: 'short'});
    } else {
        return date.toLocaleDateString([], {month: 'short', day: 'numeric'});
    }
}

function getStatusIcon(status) {
    switch(status) {
        case 'sent': return '‚úì';
        case 'delivered': return '‚úì‚úì';
        case 'read': return '‚úì‚úì';
        default: return 'üïì';
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => {
    loadChats();
    
    // –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Å–∫—Ä–æ–ª–ª
    const chatsList = document.getElementById('chatsList');
    chatsList.addEventListener('scroll', () => {
        if (chatsList.scrollTop + chatsList.clientHeight >= chatsList.scrollHeight - 100 && !allChatsLoaded) {
            loadChats();
        }
    });
    
    // Polling –¥–ª—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    setInterval(() => {
        if (currentChatId) {
            checkNewMessages(currentChatId);
        }
    }, 3000);
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async function checkNewMessages(chatId) {
    try {
        const response = await fetch(`/api/check_messages/${chatId}`);
        const data = await response.json();
        
        if (data.success && data.has_new) {
            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
            const messagesContainer = document.getElementById('messagesContainer');
            if (messagesContainer) {
                // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                data.new_messages.forEach(msg => {
                    const time = new Date(msg.date * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    const messageHtml = `
                        <div class="message-wrapper ${msg.outgoing ? 'outgoing' : 'incoming'}">
                            <div class="message ${msg.outgoing ? 'outgoing' : 'incoming'}">
                                <div class="message-text">${escapeHtml(msg.text)}</div>
                                <div class="message-time">
                                    ${time}
                                    ${msg.outgoing ? `<span class="message-status">${getStatusIcon(msg.status)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                });
                
                // –ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
    }
}
</script>
{% endblock %}
'''

# –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–ë–û–¢–´ –° PYROGRAM ==============================================

def get_client(user_id: int) -> Optional[Client]:
    """–ü–æ–ª—É—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç Pyrogram –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    if user_id in clients:
        return clients[user_id]
    
    # –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–µ—Å—Å–∏—é –∏–∑ –ë–î
    conn = sqlite3.connect(SESSION_DB)
    c = conn.cursor()
    c.execute("SELECT session_string FROM user_sessions WHERE user_id = ?", (user_id,))
    result = c.fetchone()
    conn.close()
    
    if result:
        session_string = result[0]
        # –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Å–µ—Å—Å–∏–∏
        # –ó–¥–µ—Å—å –Ω—É–∂–Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏
        pass
    
    return None

async def create_client(api_id: int, api_hash: str, phone: str = None) -> Client:
    """–°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç Pyrogram"""
    session_name = f"session_{hashlib.md5(phone.encode()).hexdigest()}" if phone else "temp_session"
    
    client = Client(
        name=session_name,
        api_id=api_id,
        api_hash=api_hash,
        workdir=str(BASE_DIR / "sessions")
    )
    
    return client

def save_session_to_db(user_id: int, session_string: str, phone: str):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é –≤ –ë–î"""
    conn = sqlite3.connect(SESSION_DB)
    c = conn.cursor()
    c.execute(
        "INSERT OR REPLACE INTO user_sessions (user_id, session_string, phone_number) VALUES (?, ?, ?)",
        (user_id, session_string, phone)
    )
    conn.commit()
    conn.close()

def save_api_credentials(api_id: int, api_hash: str):
    """–°–æ—Ö—Ä–∞–Ω–∏—Ç—å API credentials –≤ –ë–î"""
    conn = sqlite3.connect(SESSION_DB)
    c = conn.cursor()
    c.execute(
        "INSERT INTO api_credentials (api_id, api_hash) VALUES (?, ?)",
        (api_id, api_hash)
    )
    conn.commit()
    conn.close()

def get_api_credentials() -> Tuple[int, str]:
    """–ü–æ–ª—É—á–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ API credentials –∏–∑ –ë–î"""
    conn = sqlite3.connect(SESSION_DB)
    c = conn.cursor()
    c.execute("SELECT api_id, api_hash FROM api_credentials ORDER BY id DESC LIMIT 1")
    result = c.fetchone()
    conn.close()
    
    if result:
        return result[0], result[1]
    return None, None

# –ú–ê–†–®–†–£–¢–´ FLASK =============================================================

@app.route('/')
def index():
    """–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞"""
    if 'user_id' in session:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - –ø–æ–∫–∞–∑–∞—Ç—å –≥–ª–∞–≤–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        api_id, api_hash = get_api_credentials()
        if not api_id or not api_hash:
            return redirect(url_for('api_login'))
        
        # –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
        client = get_client(session['user_id'])
        if client:
            return render_template_string(MAIN_HTML, user=client.get_me())
        
        return render_template_string(MAIN_HTML, user={'first_name': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'})
    
    # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ API credentials
    api_id, api_hash = get_api_credentials()
    if api_id and api_hash:
        return redirect(url_for('phone'))
    
    return render_template_string(LOGIN_HTML)

@app.route('/api/login', methods=['POST'])
def api_login():
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ API credentials"""
    api_id = request.form.get('api_id')
    api_hash = request.form.get('api_hash')
    
    if not api_id or not api_hash:
        return render_template_string(LOGIN_HTML, error="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è")
    
    try:
        api_id = int(api_id)
        save_api_credentials(api_id, api_hash)
        session['api_id'] = api_id
        session['api_hash'] = api_hash
        return redirect(url_for('phone'))
    except ValueError:
        return render_template_string(LOGIN_HTML, error="API ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º")

@app.route('/phone')
def phone():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞"""
    if 'api_id' not in session or 'api_hash' not in session:
        return redirect(url_for('index'))
    return render_template_string(PHONE_HTML)

@app.route('/send_code', methods=['POST'])
def send_code():
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    phone_number = request.form.get('phone')
    
    if not phone_number:
        return render_template_string(PHONE_HTML, error="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞")
    
    try:
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–º–µ—Ä –≤ —Å–µ—Å—Å–∏–∏
        session['phone'] = phone_number
        
        # –°–æ–∑–¥–∞—Ç—å –∫–ª–∏–µ–Ω—Ç –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        client = loop.run_until_complete(create_client(
            session['api_id'],
            session['api_hash'],
            phone_number
        ))
        
        async def send_code_async():
            await client.connect()
            sent_code = await client.send_code(phone_number)
            return sent_code.phone_code_hash
        
        phone_code_hash = loop.run_until_complete(send_code_async())
        loop.run_until_complete(client.disconnect())
        
        # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å hash –∫–æ–¥–∞ –≤ —Å–µ—Å—Å–∏–∏
        session['phone_code_hash'] = phone_code_hash
        
        return redirect(url_for('code'))
    except Exception as e:
        return render_template_string(PHONE_HTML, error=f"–û—à–∏–±–∫–∞: {str(e)}")

@app.route('/code')
def code():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–≤–æ–¥–∞ –∫–æ–¥–∞"""
    if 'phone' not in session or 'phone_code_hash' not in session:
        return redirect(url_for('phone'))
    return render_template_string(CODE_HTML, phone=session['phone'])

@app.route('/verify_code', methods=['POST'])
def verify_code():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"""
    code = request.form.get('code')
    
    if not code or len(code) != 5:
        return render_template_string(CODE_HTML, phone=session['phone'], error="–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥")
    
    try:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        client = loop.run_until_complete(create_client(
            session['api_id'],
            session['api_hash'],
            session['phone']
        ))
        
        async def sign_in_async():
            await client.connect()
            
            try:
                signed_in = await client.sign_in(
                    phone_number=session['phone'],
                    phone_code_hash=session['phone_code_hash'],
                    phone_code=code
                )
                
                # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                user_id = signed_in.id
                clients[user_id] = client
                
                # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é –≤ –ë–î
                session_string = await client.export_session_string()
                save_session_to_db(user_id, session_string, session['phone'])
                
                # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å user_id –≤ —Å–µ—Å—Å–∏–∏ Flask
                session['user_id'] = user_id
                
                # –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                session.pop('phone_code_hash', None)
                
                await client.disconnect()
                return True, None
                
            except SessionPasswordNeeded:
                # –ù—É–∂–µ–Ω –ø–∞—Ä–æ–ª—å 2FA
                session['needs_password'] = True
                await client.disconnect()
                return False, 'password'
            except PhoneCodeInvalid:
                return False, '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥'
            except PhoneCodeExpired:
                return False, '–ö–æ–¥ —É—Å—Ç–∞—Ä–µ–ª'
        
        success, result = loop.run_until_complete(sign_in_async())
        
        if success:
            return redirect(url_for('index'))
        elif result == 'password':
            return redirect(url_for('password'))
        else:
            return render_template_string(CODE_HTML, phone=session['phone'], error=result)
            
    except FloodWait as e:
        wait_time = e.value
        return render_template_string(CODE_HTML, phone=session['phone'], 
                                   error=f"–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫. –ü–æ–¥–æ–∂–¥–∏—Ç–µ {wait_time} —Å–µ–∫—É–Ω–¥")
    except Exception as e:
        return render_template_string(CODE_HTML, phone=session['phone'], error=f"–û—à–∏–±–∫–∞: {str(e)}")

@app.route('/resend_code', methods=['POST'])
def resend_code():
    """–ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–¥–∞"""
    data = request.get_json()
    phone = data.get('phone')
    
    if not phone:
        return jsonify({'success': False, 'error': '–ù–µ—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'})
    
    try:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        client = loop.run_until_complete(create_client(
            session['api_id'],
            session['api_hash'],
            phone
        ))
        
        async def resend_code_async():
            await client.connect()
            sent_code = await client.send_code(phone)
            return sent_code.phone_code_hash
        
        phone_code_hash = loop.run_until_complete(resend_code_async())
        loop.run_until_complete(client.disconnect())
        
        # –û–±–Ω–æ–≤–∏—Ç—å hash –∫–æ–¥–∞ –≤ —Å–µ—Å—Å–∏–∏
        session['phone_code_hash'] = phone_code_hash
        
        return jsonify({'success': True})
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/password')
def password():
    """–°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤–≤–æ–¥–∞ –ø–∞—Ä–æ–ª—è 2FA"""
    if 'needs_password' not in session:
        return redirect(url_for('code'))
    return render_template_string(PASSWORD_HTML)

@app.route('/check_password', methods=['POST'])
def check_password():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è 2FA"""
    password = request.form.get('password')
    
    if not password:
        return render_template_string(PASSWORD_HTML, error="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å")
    
    try:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        client = loop.run_until_complete(create_client(
            session['api_id'],
            session['api_hash'],
            session['phone']
        ))
        
        async def check_password_async():
            await client.connect()
            
            try:
                signed_in = await client.check_password(password)
                
                # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞
                user_id = signed_in.id
                clients[user_id] = client
                
                # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ—Å—Å–∏—é –≤ –ë–î
                session_string = await client.export_session_string()
                save_session_to_db(user_id, session_string, session['phone'])
                
                # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å user_id –≤ —Å–µ—Å—Å–∏–∏ Flask
                session['user_id'] = user_id
                
                # –û—á–∏—Å—Ç–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                session.pop('needs_password', None)
                session.pop('phone_code_hash', None)
                
                await client.disconnect()
                return True
            except Exception as e:
                return False, str(e)
        
        success, error = loop.run_until_complete(check_password_async())
        
        if success:
            return redirect(url_for('index'))
        else:
            return render_template_string(PASSWORD_HTML, error=f"–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å: {error}")
            
    except Exception as e:
        return render_template_string(PASSWORD_HTML, error=f"–û—à–∏–±–∫–∞: {str(e)}")

@app.route('/logout')
def logout():
    """–í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã"""
    # –û—Ç–∫–ª—é—á–∏—Ç—å –∫–ª–∏–µ–Ω—Ç Pyrogram
    user_id = session.get('user_id')
    if user_id and user_id in clients:
        try:
            loop = asyncio.new_event_loop()
            asyncio.set_event_loop(loop)
            loop.run_until_complete(clients[user_id].disconnect())
        except:
            pass
        clients.pop(user_id, None)
    
    # –û—á–∏—Å—Ç–∏—Ç—å —Å–µ—Å—Å–∏—é Flask
    session.clear()
    return redirect(url_for('index'))

# API –ú–ê–†–®–†–£–¢–´ ===============================================================

@app.route('/api/chats')
def api_chats():
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'})
    
    try:
        offset = int(request.args.get('offset', 0))
        limit = int(request.args.get('limit', 20))
        
        client = get_client(session['user_id'])
        if not client:
            return jsonify({'success': False, 'error': '–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'})
        
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        async def get_chats_async():
            await client.connect()
            dialogs = await client.get_dialogs(limit=limit, offset=offset)
            await client.disconnect()
            
            chats = []
            for dialog in dialogs:
                chat = {
                    'id': dialog.chat.id,
                    'title': get_chat_title(dialog.chat),
                    'type': str(dialog.chat.type),
                    'last_message': dialog.top_message.text[:50] if dialog.top_message and hasattr(dialog.top_message, 'text') else '',
                    'last_message_date': dialog.top_message.date.timestamp() if dialog.top_message else None,
                    'unread_count': dialog.unread_messages_count,
                    'is_online': getattr(dialog.chat, 'status', None) == enums.UserStatus.RECENTLY,
                    'photo': None
                }
                
                # –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ—Ç–æ —á–∞—Ç–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å)
                if hasattr(dialog.chat, 'photo'):
                    chat['photo'] = f"chat_{dialog.chat.id}_photo.jpg"
                
                chats.append(chat)
            
            return chats
        
        chats = loop.run_until_complete(get_chats_async())
        return jsonify({'success': True, 'chats': chats})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/messages/<int:chat_id>')
def api_messages(chat_id):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞—Ç–∞"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'})
    
    try:
        client = get_client(session['user_id'])
        if not client:
            return jsonify({'success': False, 'error': '–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'})
        
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        async def get_messages_async():
            await client.connect()
            messages = await client.get_chat_history(chat_id, limit=50)
            await client.disconnect()
            
            formatted_messages = []
            for message in messages:
                msg = {
                    'id': message.id,
                    'text': message.text or (message.caption or ''),
                    'date': message.date.timestamp(),
                    'outgoing': message.outgoing,
                    'status': 'sent',
                    'media': None
                }
                
                # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–µ–¥–∏–∞
                if message.photo:
                    msg['media'] = f"media_{message.id}.jpg"
                
                formatted_messages.append(msg)
            
            return formatted_messages
        
        messages = loop.run_until_complete(get_messages_async())
        return jsonify({'success': True, 'messages': messages})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/send_message', methods=['POST'])
def api_send_message():
    """API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'})
    
    try:
        data = request.get_json()
        chat_id = data.get('chat_id')
        text = data.get('text')
        
        if not chat_id or not text:
            return jsonify({'success': False, 'error': '–ù–µ —É–∫–∞–∑–∞–Ω chat_id –∏–ª–∏ —Ç–µ–∫—Å—Ç'})
        
        client = get_client(session['user_id'])
        if not client:
            return jsonify({'success': False, 'error': '–ö–ª–∏–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'})
        
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
        
        async def send_message_async():
            await client.connect()
            sent_message = await client.send_message(chat_id, text)
            await client.disconnect()
            
            return {
                'id': sent_message.id,
                'text': sent_message.text,
                'date': sent_message.date.timestamp(),
                'outgoing': True,
                'status': 'sent'
            }
        
        message = loop.run_until_complete(send_message_async())
        return jsonify({'success': True, 'message': message})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)})

@app.route('/api/check_messages/<int:chat_id>')
def api_check_messages(chat_id):
    """API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    if 'user_id' not in session:
        return jsonify({'success': False, 'error': '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω'})
    
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è
    # –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —á–µ—Ä–µ–∑ long polling –∏–ª–∏ websockets
    return jsonify({'success': True, 'has_new': False, 'new_messages': []})

@app.route('/api/media/<path:filename>')
def api_media(filename):
    """API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤"""
    # –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤
    # –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ –∑–¥–µ—Å—å –±—ã–ª–∞ –±—ã –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –º–µ–¥–∏–∞
    return jsonify({'success': False, 'error': '–ú–µ–¥–∏–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ'})

# –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===================================================

def get_chat_title(chat):
    """–ü–æ–ª—É—á–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —á–∞—Ç–∞"""
    if hasattr(chat, 'title') and chat.title:
        return chat.title
    elif hasattr(chat, 'first_name'):
        name = chat.first_name or ''
        if hasattr(chat, 'last_name') and chat.last_name:
            name += f" {chat.last_name}"
        return name.strip()
    elif hasattr(chat, 'username') and chat.username:
        return chat.username
    return f"–ß–∞—Ç {chat.id}"

# –ó–ê–ü–£–°–ö –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø ==========================================================

if __name__ == '__main__':
    print("=" * 60)
    print("Telegram Web Client")
    print("=" * 60)
    print(f"–î–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: http://localhost:5000")
    print(f"–ü–∞–ø–∫–∞ —Å —Å–µ—Å—Å–∏—è–º–∏: {BASE_DIR / 'sessions'}")
    print(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: {SESSION_DB}")
    print("=" * 60)
    
    # –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É –¥–ª—è —Å–µ—Å—Å–∏–π –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    (BASE_DIR / "sessions").mkdir(exist_ok=True)
    
    app.run(host='0.0.0.0', port=5000, debug=True)
